# 네이버 로그인 계정 생성 실패 진단 가이드

## 현재 상황

- ✅ 프록시 서버 응답: 정상 (base64url 인코딩됨)
- ✅ 네이버 로그인: 성공 (네이버 인증 완료)
- ❌ Clerk 계정 생성: 실패
- ❌ 세션 생성: 실패

## 단계별 진단

### Step 1: 브라우저 콘솔 로그 확인

네이버 로그인 후 브라우저 콘솔(F12)에서 다음 로그를 확인하세요:

1. **AuthSessionSync 로그**
   ```
   [AuthSessionSync] OAuth 콜백 감지 - 세션 생성 검증 시작
   ```
   - `isSignedIn`: true/false?
   - `userId`: 있음/없음?
   - `sessionId`: 있음/없음?
   - `External Account`: 연결됨/없음?

2. **에러 메시지**
   - "The External Account was not found" 에러 확인
   - 기타 Clerk 에러 메시지 확인

### Step 2: Network 탭 확인

Network 탭에서 다음 요청을 확인하세요:

1. **프록시 서버 호출 확인**
   - `http://15.165.148.244:3001/` 요청이 있는지 확인
   - 요청이 있다면:
     - Status Code: 200?
     - Response: base64url 인코딩된 `sub` 포함?
   - 요청이 없다면:
     - Clerk가 프록시 서버를 호출하지 않음
     - UserInfo URL 설정 확인 필요

2. **Clerk API 호출 확인**
   - `/v1/oauth_callback` 요청 확인
   - `/v1/client/sign_ins` 요청 확인
   - 실패한 요청(빨간색) 클릭하여 Response 확인

### Step 3: 프록시 서버 로그 확인

```bash
ssh -i "aws_server.pem" ubuntu@15.165.148.244
pm2 logs clerk-userinfo-proxy --lines 50
```

확인 사항:
- Clerk가 프록시 서버를 호출했는지
- 프록시 서버가 네이버 UserInfo API를 호출했는지
- 응답이 base64url로 인코딩되었는지
- 에러 로그가 있는지

### Step 4: Clerk Dashboard 확인

1. **SSO Connections → 네이버**
   - UserInfo URL: `http://15.165.148.244:3001/` 확인
   - Attribute Mapping:
     - User ID / Subject → `sub` (대소문자 주의)
     - Email → `email`
   - "Allow users to sign up": Enabled 확인

2. **Settings → User Management**
   - "Allow users to sign up": Enabled 확인
   - "Email address": Required 또는 Optional 확인

3. **Logs 탭**
   - 최근 OAuth 관련 로그 확인
   - 에러 메시지 확인
   - 특히 "External Account was not found" 에러 확인

### Step 5: 가능한 원인 및 해결 방법

#### 원인 1: 프록시 서버가 호출되지 않음

**증상**: Network 탭에 `http://15.165.148.244:3001/` 요청이 없음

**해결**:
- Clerk Dashboard → SSO Connections → 네이버
- UserInfo URL 확인: `http://15.165.148.244:3001/`
- HTTPS가 아닌 HTTP인지 확인 (프록시 서버가 HTTP로 실행 중)

#### 원인 2: 프록시 서버 응답 형식 문제

**증상**: 프록시 서버는 호출되지만 Clerk가 응답을 파싱하지 못함

**확인**:
- 프록시 서버 로그에서 최종 응답 JSON 확인
- `sub` 필드가 base64url로 인코딩되었는지 확인
- Content-Type 헤더가 `application/json`인지 확인

#### 원인 3: Attribute Mapping 불일치

**증상**: 프록시 서버 응답은 정상이지만 Clerk가 매핑하지 못함

**해결**:
- Clerk Dashboard → SSO Connections → 네이버 → Attribute Mapping
- User ID / Subject → `sub` (정확히 소문자 `sub`)
- Email → `email` (정확히 소문자 `email`)

#### 원인 4: 이메일 중복

**증상**: 같은 이메일이 이미 다른 사용자와 연결됨

**해결**:
- Clerk Dashboard → Users
- `ttottoangseu@naver.com`으로 검색
- 기존 사용자 삭제 또는 External Account 연결 확인

#### 원인 5: Clerk 정책 제한

**증상**: "Allow users to sign up" 비활성화 또는 다른 정책 제한

**해결**:
- Clerk Dashboard → Settings → User Management
- "Allow users to sign up": Enabled 확인
- SSO Connections → 네이버 → Settings
- "Allow users to sign up": Enabled 확인

## 즉시 확인할 사항

1. **브라우저 콘솔 로그 복사**
   - 네이버 로그인 시도 후
   - `[AuthSessionSync]` 로그 전체 복사
   - `[useSyncUser]` 로그 전체 복사

2. **Network 탭 스크린샷**
   - 프록시 서버 호출 여부
   - Clerk API 호출 실패 여부

3. **프록시 서버 로그 확인**
   - 최근 50줄 로그 확인
   - Clerk 호출 여부 확인

## 다음 단계

위 정보를 확인한 후 공유해주시면 정확한 원인을 파악할 수 있습니다.

특히 다음 정보가 중요합니다:
- 브라우저 콘솔의 `[AuthSessionSync]` 로그
- Network 탭의 프록시 서버 호출 여부
- 프록시 서버 로그의 최근 요청

