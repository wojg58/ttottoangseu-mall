아래 문서는 “1년차 주니어 개발자”가 **Clerk 커스텀 OAuth(네이버) 연동에서 ‘데이터는 오는데 로그인/유저 생성이 안 되는’ 문제를 끝까지 검증**할 수 있게 만든 체크리스트형 MD입니다. 그대로 복사해서 노션/깃헙에 붙이면 됩니다.

---

# Clerk 네이버 로그인 “유저 생성/로그인 실패” 검증 체크리스트 (UserInfo Proxy 기반)

**작성일:** 2026-01-04

**목표:**

- 네이버 OAuth는 성공(토큰/유저정보 수신)하지만
- Clerk에서 “유저 정보 없음 / 로그인 안 됨”이 발생하는 문제를
    
    **네트워크 → 프록시 → Clerk 설정 → 앱 플로우** 순서로 확정 진단한다.
    

---

## 0) 전제(현재 구성)

- Clerk Custom OAuth Provider 사용
- 네이버 UserInfo 응답이 중첩(JSON)이라 Proxy 서버를 둠
- Proxy는 네이버 UserInfo(`https://openapi.naver.com/v1/nid/me`)를 호출하고
    
    `sub/email/name/picture` 등 flat JSON으로 변환해 Clerk에 반환
    

---

## 1) 성공 기준(Definition of Done)

아래 4개가 모두 만족되면 “연동 성공”이다.

1. **Clerk → Proxy 요청이 실제로 들어온다**
2. Proxy가 네이버 UserInfo를 **200 OK**로 받고,
3. Proxy가 Clerk에 반환하는 응답에 **`sub` + `email`*이 존재한다
4. OAuth 콜백 이후 Clerk에서 **세션 생성(createdSessionId)** 혹은 로그인 완료가 된다
    
    (앱에서 `currentUser`가 null이 아님)
    

---

## 2) 1차 진단: “Clerk가 Proxy를 진짜 호출하나?” (도달성/HTTPS)

### 2.1 Proxy 로그로 확인 (가장 중요)

Proxy 서버 로그에서 아래가 찍혀야 한다:

- `[INFO] 요청 수신: GET /` 또는 `POST /`
- `[INFO] 헤더: authorization: Bearer ***`

✅ **판정**

- 로그가 **안 찍힘** → Clerk가 Proxy를 못 때림 = **네트워크/HTTPS 문제 확정**
- 로그가 **찍힘** → 다음 단계로 이동

### 2.2 외부 접근 조건 체크(필수)

Clerk는 “사용자 브라우저”가 아니라 **Clerk 서버에서** UserInfo URL을 호출한다.

따라서 Proxy 엔드포인트는 아래 조건을 만족해야 한다.

- [ ]  Public DNS 또는 공인 IP로 접근 가능
- [ ]  **HTTPS 권장(사실상 필수로 보는 게 안전)**
- [ ]  방화벽/보안그룹에서 inbound 허용(예: 443)
- [ ]  (가능하면) Nginx/Cloudflare/ALB로 TLS 종료

📌 **주의**

- `http://<ip>:3001/` 같은 형태는 환경에 따라 Clerk가 차단/실패할 수 있음
    
    → **https://auth-proxy.example.com/userinfo** 같은 형태 권장
    

---

## 3) 2차 진단: “Method/Token 전달 방식 불일치” (GET만 허용 문제)

현재 Proxy는 GET만 허용한다:

- GET ✅
- OPTIONS ✅
- POST ❌ (405 반환)

### 3.1 Proxy 로그에서 method 확인

- [ ]  Clerk 요청이 `GET`인지 `POST`인지 확인

✅ **판정**

- `POST`로 찍히면 → **바로 원인 후보 1순위**
    - Proxy가 405로 막아 Clerk는 UserInfo를 못 받고 “유저 없음”으로 이어질 수 있다

### 3.2 해결 가이드(권장 패치)

- [ ]  GET + POST 둘 다 허용
- [ ]  Authorization 헤더가 없는 경우 `access_token` query도 fallback 허용

(패치는 시니어가 PR로 제공하거나, 아래 TODO에 따라 수정)

**TODO**

- [ ]  `req.method !== "GET" && req.method !== "POST"` 형태로 수정
- [ ]  `access_token` query param 지원 추가

---

## 4) 3차 진단: “Proxy 응답이 Clerk가 기대하는 필드를 만족하나?” (sub/email)

Clerk가 유저를 생성하려면 최소한 다음이 안정적으로 필요하다:

- **고유 식별자:** `sub`
- **이메일:** `email` (인스턴스 설정에 따라 필수)

### 4.1 Proxy 응답 JSON 확인

Proxy 로그에 찍힌 최종 응답(flat JSON)에 아래가 있는지 확인:

- [ ]  `sub` 값 존재
- [ ]  `email` 값 존재
- [ ]  `name` (권장)
- [ ]  `picture` (권장)

✅ **판정**

- `sub` 없음 → 네이버 `response.id` 파싱/권한 문제
- `email` 없음 → 네이버에서 email scope/동의 누락 가능성이 큼

### 4.2 네이버 측 설정 체크(이메일 동의)

- [ ]  네이버 개발자 콘솔에서 “제공 정보”에 이메일이 포함되어 있는가?
- [ ]  실제 로그인 화면에서 이메일 제공 동의가 뜨는가?

📌 이메일은 “사용자가 동의 안 하면” null로 올 수 있다.

즉, “필수로 받는다”고 생각해도 실제론 빠질 수 있다.

---

## 5) 4차 진단: “Clerk Dashboard 매핑이 맞나?” (Attribute mapping)

Proxy가 완벽해도, Clerk에서 매핑이 틀리면 로그인/유저생성이 안 된다.

### 5.1 최소 매핑(반드시)

Clerk Dashboard → Custom OAuth Provider 설정에서:

- [ ]  User ID / Subject → `sub`
- [ ]  Email → `email`

### 5.2 권장 매핑

- [ ]  Name → `name`
- [ ]  Avatar/Picture → `picture`

✅ **판정**

- `sub/email` 둘 다 응답에 있는데도 실패한다면
    
    → 매핑이 잘못됐을 확률이 매우 높다(필드명 오타, 다른 키로 매핑 등)
    

---

## 6) 5차 진단: “앱(Next.js)에서 OAuth 콜백 처리 플로우가 완료되나?”

### 6.1 대표 증상

- 네이버 로그인 성공
- Proxy도 정상 200
- 그런데 앱에서 `currentUser`가 계속 null

이 경우는 **세션 생성이 완료되지 않았거나**, “추가 정보 필요(missing requirements)” 상태일 수 있다.

### 6.2 확인 포인트

- [ ]  OAuth 콜백 이후에 Clerk가 **세션을 생성했는지** 확인
- [ ]  커스텀 UI/커스텀 라우팅을 쓴다면 콜백 처리 코드에서
    
    “세션 생성 ID(createdSessionId)”가 비어있는 케이스를 처리하는지 확인
    

✅ **판정**

- createdSessionId가 비어있다 → "추가 정보 입력 필요" 플로우를 태워야 함

---

## 9) 최종 진단: "Debug 페이지에서 정보는 파싱되지만 사용자 생성 실패"

### 9.1 증상

- ✅ Clerk Debug 페이지에서 User Info가 올바르게 파싱됨
- ✅ `sub`, `email` 등 모든 필드가 정상적으로 표시됨
- ❌ 하지만 실제 로그인 시 사용자가 생성되지 않음

### 9.2 가능한 원인

1. **이메일 중복 문제**
   - 같은 이메일(`ttottoangseu@naver.com`)이 이미 다른 사용자와 연결되어 있을 수 있음
   - Clerk Dashboard → Users에서 해당 이메일로 검색하여 확인

2. **Clerk의 정책 설정**
   - Clerk Dashboard → Settings → User Management
   - "Allow users to sign up" 설정 확인
   - "Email address" 정책 확인

3. **Debug 모드와 실제 플로우의 차이**
   - Debug 페이지는 테스트용이며, 실제 OAuth 플로우와 다를 수 있음
   - 실제 로그인 플로우에서 에러가 발생할 수 있음

### 9.3 해결 방법

#### 방법 1: 기존 사용자 확인 및 삭제

Clerk Dashboard → Users에서:
- `ttottoangseu@naver.com`으로 검색
- 같은 이메일을 가진 사용자가 있으면 삭제 또는 External Account 연결 확인

#### 방법 2: Clerk 정책 확인

Clerk Dashboard → Settings → User Management:
- "Allow users to sign up" 활성화 확인
- "Email address" 정책 확인 (필수 여부 등)

#### 방법 3: 실제 로그인 플로우에서 에러 확인

- 네이버 로그인 시도
- 브라우저 콘솔에서 Clerk 에러 메시지 확인
- Network 탭에서 Clerk API 호출 확인

### 9.4 체크리스트

- [ ] Clerk Dashboard → Users에서 `ttottoangseu@naver.com` 검색
- [ ] 같은 이메일을 가진 사용자 존재 여부 확인
- [ ] Settings → User Management → "Allow users to sign up" 확인
- [ ] 실제 로그인 시 브라우저 콘솔 에러 확인
- [ ] Network 탭에서 Clerk API 호출 실패 여부 확인

### 9.5 실제 로그인 플로우 확인 (중요!)

Debug 페이지는 **테스트용**이며, 실제 OAuth 플로우와 다를 수 있습니다.

**실제 로그인 시 확인 사항:**

1. **브라우저 콘솔 에러 확인**
   - 네이버 로그인 버튼 클릭
   - 네이버 로그인 완료 후 리다이렉트
   - 브라우저 콘솔(F12)에서 Clerk 관련 에러 확인
   - 특히 "External Account was not found" 에러 확인

2. **Network 탭 확인**
   - Clerk API 호출 실패 여부 확인
   - `/v1/oauth_callback` 호출 확인
   - 에러 응답 코드 확인

3. **Clerk Dashboard → Logs 확인**
   - Clerk Dashboard → Logs 탭
   - 최근 OAuth 관련 로그 확인
   - 에러 메시지 확인

### 9.6 가능한 해결 방법

#### 방법 1: Clerk 정책 확인 및 수정

Clerk Dashboard → Settings → User Management:
- "Allow users to sign up" → **Enabled** 확인
- "Email address" → **Required** 또는 **Optional** 확인
- "Username" → **Optional** 권장 (네이버는 username을 제공하지 않음)

#### 방법 2: SSO Connections 설정 확인

Clerk Dashboard → SSO Connections → 네이버:
- Settings 탭:
  - "Allow users to sign up" → **Enabled** 확인
  - "Sync user attributes on sign in" → **Enabled** 확인
- Advanced Settings:
  - 추가 제한 사항이 있는지 확인

#### 방법 3: 실제 로그인 플로우에서 에러 확인

네이버 로그인을 실제로 시도하고:
1. 브라우저 콘솔에서 에러 메시지 확인
2. Network 탭에서 실패한 API 호출 확인
3. Clerk Dashboard → Logs에서 에러 로그 확인

**가장 가능성 높은 원인:**
- ✅ "Allow users to sign up" 설정은 활성화되어 있음 (확인 완료)
- ❌ **세션도 생성되지 않음** (확인 완료)
- ❓ 실제 로그인 플로우에서 Clerk가 사용자 생성을 거부하는 다른 이유
  - Clerk Dashboard → Logs에서 에러 확인 필요
  - 브라우저 콘솔에서 Clerk 에러 확인 필요

### 9.8 세션 생성 실패 진단

**증상:**
- ✅ 프록시 서버: 정상 작동
- ✅ Attribute Mapping: 정상 설정
- ✅ Debug 페이지: 정보 파싱 성공
- ✅ "Allow users to sign up": 활성화됨
- ❌ **세션 생성 실패**
- ❌ **사용자 생성 실패**

**이것은 Clerk가 OAuth 콜백을 받았지만 사용자 생성을 시도하지 않았거나 실패했다는 의미입니다.**

**확인해야 할 사항:**

1. **Clerk Dashboard → Logs**
   - 최근 OAuth 관련 로그 확인
   - 에러 메시지 확인 (특히 "External Account was not found" 또는 "Unable to complete action")
   - 세션 생성 실패 원인 확인

2. **실제 로그인 시 브라우저 콘솔**
   - 네이버 로그인 버튼 클릭
   - 네이버 로그인 완료 후 리다이렉트
   - 브라우저 콘솔(F12)에서 Clerk 에러 확인

3. **Network 탭**
   - Clerk API 호출 실패 여부 확인
   - `/v1/oauth_callback` 호출 확인
   - 에러 응답 코드 확인

**가능한 원인:**
1. Clerk가 Proxy 응답을 받았지만 사용자 생성을 거부함
2. Clerk의 다른 정책 설정 문제
3. 실제 OAuth 플로우에서 에러 발생
4. Clerk의 내부 검증 실패

### 9.7 Debug 모드 vs 실제 플로우 차이

**중요**: Debug 페이지는 **테스트용**이며, 실제 OAuth 플로우와 다를 수 있습니다.

**Debug 모드:**
- Clerk가 직접 UserInfo를 호출하여 테스트
- 사용자 생성 없이 파싱만 확인

**실제 OAuth 플로우:**
- 네이버 → Clerk 콜백 → Clerk가 UserInfo 호출 → 사용자 생성 시도
- 이 과정에서 에러가 발생하면 사용자가 생성되지 않음

**확인 방법:**
1. 실제 네이버 로그인 버튼 클릭
2. 네이버 로그인 완료 후 리다이렉트
3. 브라우저 콘솔(F12)에서 에러 확인
4. Network 탭에서 Clerk API 호출 확인
5. Clerk Dashboard → Logs에서 에러 로그 확인

### 9.9 OAuth 콜백 응답 확인

**303 See Other 응답:**
- ✅ **정상입니다!** 이것은 Clerk가 네이버에서 Authorization Code를 받고 리다이렉트하는 정상적인 응답입니다.
- 303 See Other는 "다른 위치로 리다이렉트하라"는 의미입니다.

**문제는 303 리다이렉트 이후에 발생합니다:**

1. **Clerk가 네이버에서 Authorization Code를 받음** (303 응답)
2. **Clerk가 네이버 Token URL로 Access Token 요청**
3. **Clerk가 Proxy 서버로 UserInfo 요청** (프록시 로그에서 확인됨)
4. **Proxy가 올바른 응답 반환** (sub, email 포함)
5. ❌ **Clerk가 사용자 생성을 시도하지만 실패** ← 여기서 문제 발생

**확인해야 할 사항:**

1. **Clerk Dashboard → Logs**
   - 최근 OAuth 관련 로그 확인
   - 특히 "External Account was not found" 또는 "Unable to complete action" 에러 확인
   - 세션 생성 실패 원인 확인

2. **프록시 서버 로그 재확인**
   - Clerk가 Proxy를 호출했는지 확인
   - Proxy 응답이 올바른지 확인
   - 에러 로그가 있는지 확인

3. **실제 로그인 시 브라우저 콘솔**
   - 네이버 로그인 완료 후 리다이렉트
   - 브라우저 콘솔(F12)에서 Clerk 에러 확인
   - 특히 "External Account was not found" 에러 확인

### 9.10 sub 필드 형식 문제 (가능한 원인)

**문제:**
- 네이버에서 반환하는 `sub` 값: `WhNLW9CXcPmXkEpk-e8vs4pRRgRrhSj009HXFo-2mbQ`
- 하이픈(`-`)이 여러 개 포함되어 있고, 길이가 상당히 김
- Clerk가 `sub` 필드의 형식을 검증하여 사용자 생성을 거부할 수 있음

**해결 방법:**
1. **base64url 인코딩** (현재 적용됨)
   - `sub` 값을 base64url로 인코딩하여 URL-safe 형식으로 변환
   - 프록시 서버에서 자동으로 변환됨
   - 예: `WhNLW9CXcPmXkEpk-e8vs4pRRgRrhSj009HXFo-2mbQ` → base64url 인코딩

2. **프록시 서버 재배포 필요**
   - 변경된 프록시 서버 코드를 AWS EC2에 배포
   - PM2로 재시작: `pm2 restart clerk-userinfo-proxy`

**확인 방법:**
1. 프록시 서버 로그에서 변환된 `sub` 값 확인
2. Clerk Debug 페이지에서 새로운 `sub` 값 확인
3. 실제 로그인 시도하여 사용자 생성 여부 확인

### 9.11 Network 탭에서 실패한 요청 확인

**문제:**
- OAuth 콜백 후 리다이렉션이 너무 빨리 일어나서 Network 탭에서 실패한 요청을 확인할 수 없음

**해결 방법:**

1. **Network 탭 설정**
   - 브라우저 개발자 도구(F12) 열기
   - Network 탭 선택
   - **"Preserve log" 옵션 활성화** (중요!)
   - 이렇게 하면 페이지 새로고침 후에도 로그가 유지됨

2. **리다이렉션 대기 시간**
   - 현재 설정: 8-10초 대기 후 리다이렉션
   - 이 시간 동안 Network 탭에서 실패한 요청 확인 가능

3. **리다이렉션 중지 (선택적)**
   - 콘솔에서 `window.stopRedirect = true` 입력
   - 리다이렉션을 중지하고 Network 탭을 자세히 확인
   - 계속하려면: `window.stopRedirect = false` 후 `window.location.reload()`

**확인해야 할 요청:**
1. `/v1/oauth_callback` - Clerk OAuth 콜백 (303 See Other는 정상)
2. `/v1/oauth/userinfo` - Clerk가 Proxy 서버로 UserInfo 요청
3. 기타 Clerk API 호출 실패 (빨간색으로 표시됨)

**실패한 요청 확인 방법:**
- Network 탭에서 빨간색으로 표시된 요청 클릭
- Response 탭에서 에러 메시지 확인
- Headers 탭에서 요청/응답 헤더 확인

